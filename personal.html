<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SSaved</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @font-face {
            font-family: 'IBM Plex Mono';
            src: url('https://marilynliew.com/fonts/ibmplexmono-light-webfont.woff2') format('woff2');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Warm off-whites
                        warm: {
                            50: '#FAFAF8',
                            100: '#F5F5F3',
                            200: '#EEEDE9',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- BASE & WARM BACKGROUND --- */
        body {
            background: linear-gradient(180deg, #FAFAF8 0%, #F7F6F3 100%);
            min-height: 100vh;
            font-family: 'IBM Plex Mono', monospace;
        }

        /* --- FOLDER TABS --- */
        .folder-tab {
            clip-path: polygon(0 0, 85% 0, 100% 100%, 0% 100%);
            padding-left: 1.5rem;
            padding-right: 2.5rem;
        }
        .folder-drop-active .folder-tab { 
            background-color: #3b82f6 !important; 
            color: white !important; 
            transition: background-color 0.2s;
        }
        .folder-drop-active .folder-grid-area {
            background-color: rgba(59, 130, 246, 0.05);
            border-radius: 1rem;
            box-shadow: inset 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* --- CARD STYLING --- */
        .card {
            background: white;
            border-radius: 1.25rem;
            border: 1px solid rgba(0, 0, 0, 0.04);
            overflow: hidden;
            box-shadow:
                0 2px 4px -1px rgba(0, 0, 0, 0.02),
                0 8px 24px -4px rgba(0, 0, 0, 0.06);
            transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1),
                        box-shadow 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 4px 8px -2px rgba(0, 0, 0, 0.03),
                0 16px 40px -8px rgba(0, 0, 0, 0.1);
        }
        .card.is-restored {
            border-color: rgba(244, 63, 94, 0.25);
            box-shadow: 
                0 4px 8px -2px rgba(244, 63, 94, 0.08),
                0 16px 48px -8px rgba(244, 63, 94, 0.2);
        }
        .card.is-dragging {
            opacity: 0.4;
            filter: grayscale(80%);
            transform: scale(0.98);
        }

        /* --- IMAGE HOVER SCALE (Desktop only, non-touch) --- */
        @media (hover: hover) and (pointer: fine) {
            .group\/image:hover .img-hover-scale {
                transform: scale(1.02);
            }
        }

        /* --- AUTO-GROW INPUTS --- */
        .auto-grow {
            field-sizing: content;
            min-height: 24px;
            resize: none;
            overflow: hidden;
        }

        /* --- UTILITIES --- */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        ::view-transition-group(root) { animation-duration: 0.35s; animation-timing-function: cubic-bezier(0.16, 1, 0.3, 1); }
        
        /* --- ANIMATIONS --- */
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(20px) scale(0.96); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        @keyframes subtlePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-restore { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .folder-enter { animation: slideUp 0.5s ease-out forwards; }
        .animate-pulse-subtle { animation: subtlePulse 2s ease-in-out infinite; }

        /* --- UI COMPONENTS --- */
        .tooltip-arrow::after {
            content: " "; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border: 6px solid transparent; border-top-color: rgba(255,255,255,0.95); filter: drop-shadow(0 1px 2px rgb(0 0 0 / 0.08));
        }
        .tooltip-container { 
            transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1); 
            opacity: 0; 
            pointer-events: none; 
            transform: translateY(8px) scale(0.95); 
        }
        .tooltip-container.active { opacity: 1; pointer-events: auto; transform: translateY(0) scale(1); }

        /* --- UNDO BUTTON --- */
        #undoBtn.hidden-btn { opacity: 0; transform: translateX(-10px); pointer-events: none; width: 0; padding: 0; margin: 0; border: 0; }
        #undoBtn { 
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            box-shadow: 0 2px 8px -2px rgba(244, 63, 94, 0.3);
        }

        /* --- DRAG & DROP --- */
        body.global-dragging, body.global-dragging * { cursor: grabbing !important; }
        .card-shift-forward { transform: translateX(-24px); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .card-shift-backward { transform: translateX(24px); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        /* --- SLIDER STYLING --- */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            height: 16px; 
            width: 16px; 
            border-radius: 50%; 
            background: white; 
            border: 1px solid rgba(0,0,0,0.1); 
            cursor: pointer; 
            margin-top: -6px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }
        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; 
            height: 4px; 
            cursor: pointer; 
            background: rgba(0,0,0,0.08); 
            border-radius: 2px; 
        }

        /* --- HEADER --- */
        .header-glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        /* --- BUTTONS --- */
        .btn-primary {
            background: #1a1a1a;
            color: white;
            border-radius: 0.625rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 2px 8px -2px rgba(0,0,0,0.2);
        }
        .btn-primary:hover {
            background: #000;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px -2px rgba(0,0,0,0.25);
        }
        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-secondary {
            background: rgba(0,0,0,0.04);
            color: #525252;
            border-radius: 0.625rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background: rgba(0,0,0,0.08);
            color: #1a1a1a;
        }

        /* --- EXTERNAL LINK BUTTON (NEW) --- */
        .external-link-btn {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .group\/image:hover .external-link-btn {
            opacity: 1;
            transform: scale(1);
        }

        /* --- DELETE BUTTON --- */
        .delete-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .group\/image:hover .delete-btn {
            opacity: 1;
            transform: scale(1);
        }

        /* --- FOCUS STATES --- */
        textarea:focus {
            outline: none;
            border-color: rgba(0,0,0,0.2) !important;
        }
        .focus-ring:focus {
            box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.12);
        }

        /* --- DROP OVERLAY --- */
        .drop-overlay-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 1.5rem;
            box-shadow: 0 24px 80px -12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="text-neutral-900 font-sans antialiased selection:bg-rose-100 selection:text-rose-900 min-h-screen">

    <header id="mainHeader" class="header-glass px-4 md:px-6 py-3 fixed top-0 w-full z-40 transition-transform duration-300 ease-in-out">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 max-w-[1390px] mx-auto">
            <div class="flex items-center justify-between w-full md:w-auto">
                <div class="flex items-center gap-3">
                    <h1 class="text-lg font-semibold tracking-tight text-neutral-800">SSaved</h1>
                    <span id="saveIndicator" class="text-[10px] font-medium uppercase tracking-wider text-neutral-300 opacity-0 transition-opacity">Saved</span>
                </div>
                <!-- Mobile: Split action buttons -->
                <div class="md:hidden flex items-center gap-2">
                    <button onclick="createNewFolder()" class="w-9 h-9 flex items-center justify-center text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-all" title="New Folder">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6H20M22 6H20M20 6V4M20 6V8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M21.4 20H2.6C2.26863 20 2 19.7314 2 19.4V11H21.4C21.7314 11 22 11.2686 22 11.6V19.4C22 19.7314 21.7314 20 21.4 20Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2 11V4.6C2 4.26863 2.26863 4 2.6 4H8.77805C8.92127 4 9.05977 4.05124 9.16852 4.14445L12.3315 6.85555C12.4402 6.94876 12.5787 7 12.722 7H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                    <button onclick="triggerUpload()" class="w-9 h-9 flex items-center justify-center text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-all" title="Add Photo">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 4H8.8C7.11984 4 6.27976 4 5.63803 4.32698C5.07354 4.6146 4.6146 5.07354 4.32698 5.63803C4 6.27976 4 7.11984 4 8.8V15.2C4 16.8802 4 17.7202 4.32698 18.362C4.6146 18.9265 5.07354 19.3854 5.63803 19.673C6.27976 20 7.11984 20 8.8 20H15.2C16.8802 20 17.7202 20 18.362 19.673C18.9265 19.3854 19.3854 18.9265 19.673 18.362C20 17.7202 20 16.8802 20 15.2V11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 16L8.29289 11.7071C8.68342 11.3166 9.31658 11.3166 9.70711 11.7071L13 15M13 15L15.7929 12.2071C16.1834 11.8166 16.8166 11.8166 17.2071 12.2071L20 15M13 15L15.25 17.25" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M18.5 3V5.5M18.5 8V5.5M18.5 5.5H16M18.5 5.5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                </div>
            </div>
            
            <div class="flex items-center gap-2 md:gap-3 overflow-x-auto no-scrollbar w-full md:w-auto pb-1 md:pb-0">
                <button id="undoBtn" onclick="triggerUndo()" class="hidden-btn flex items-center gap-2 px-3 py-1.5 bg-rose-50 hover:bg-rose-100 text-rose-600 border border-rose-100 rounded-lg text-sm font-medium whitespace-nowrap shrink-0">
                    <i class="ph-bold ph-arrow-u-up-left"></i> <span id="undoText">Undo</span>
                </button>

                <div class="md:hidden flex bg-neutral-100/80 p-1 rounded-lg border border-neutral-200/50 shrink-0">
                    <button onclick="setMobileCols(1)" id="col-btn-1" class="w-8 h-8 flex items-center justify-center rounded-md text-neutral-400 hover:text-neutral-900 transition-all"><i class="ph-bold ph-rectangle"></i></button>
                    <button onclick="setMobileCols(2)" id="col-btn-2" class="w-8 h-8 flex items-center justify-center rounded-md text-neutral-400 hover:text-neutral-900 transition-all"><i class="ph-bold ph-columns"></i></button>
                </div>

                <div class="hidden md:flex items-center gap-2 bg-neutral-100/50 px-3 py-1.5 rounded-lg border border-neutral-200/50 shrink-0">
                    <i class="ph ph-corners-in text-neutral-400 text-sm"></i>
                    <input type="range" min="600" max="2400" value="1390" class="w-20 md:w-24" id="widthSlider" oninput="updateWidth(this.value)">
                </div>

                <div class="flex items-center gap-1 bg-neutral-100/50 p-1 rounded-lg border border-neutral-200/50 shrink-0">
                    <button onclick="triggerImport()" class="w-8 h-8 flex items-center justify-center text-neutral-400 hover:text-neutral-900 hover:bg-white rounded-md transition-all" title="Import"><i class="ph ph-upload-simple text-lg"></i></button>
                    <input type="file" id="importInput" accept=".zip" class="hidden" onchange="handleImport(this.files)">
                    <button onclick="exportData()" class="w-8 h-8 flex items-center justify-center text-neutral-400 hover:text-neutral-900 hover:bg-white rounded-md transition-all" title="Export"><i class="ph ph-download-simple text-lg"></i></button>
                    <div class="hidden md:block w-px h-4 bg-neutral-200 mx-1"></div>
                    <!-- Desktop: Split action buttons -->
                    <button onclick="createNewFolder()" class="hidden md:flex items-center gap-2 px-3 py-1.5 text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-all text-sm" title="New Folder">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6H20M22 6H20M20 6V4M20 6V8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M21.4 20H2.6C2.26863 20 2 19.7314 2 19.4V11H21.4C21.7314 11 22 11.2686 22 11.6V19.4C22 19.7314 21.7314 20 21.4 20Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2 11V4.6C2 4.26863 2.26863 4 2.6 4H8.77805C8.92127 4 9.05977 4.05124 9.16852 4.14445L12.3315 6.85555C12.4402 6.94876 12.5787 7 12.722 7H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                    <button onclick="triggerUpload()" class="hidden md:flex items-center gap-2 px-3 py-1.5 text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-all text-sm" title="Add Photo">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 4H8.8C7.11984 4 6.27976 4 5.63803 4.32698C5.07354 4.6146 4.6146 5.07354 4.32698 5.63803C4 6.27976 4 7.11984 4 8.8V15.2C4 16.8802 4 17.7202 4.32698 18.362C4.6146 18.9265 5.07354 19.3854 5.63803 19.673C6.27976 20 7.11984 20 8.8 20H15.2C16.8802 20 17.7202 20 18.362 19.673C18.9265 19.3854 19.3854 18.9265 19.673 18.362C20 17.7202 20 16.8802 20 15.2V11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 16L8.29289 11.7071C8.68342 11.3166 9.31658 11.3166 9.70711 11.7071L13 15M13 15L15.7929 12.2071C16.1834 11.8166 16.8166 11.8166 17.2071 12.2071L20 15M13 15L15.25 17.25" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M18.5 3V5.5M18.5 8V5.5M18.5 5.5H16M18.5 5.5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                    <input type="file" id="fileInput" multiple accept="image/*" class="hidden" onchange="handleFiles(this.files)">
                </div>
            </div>
        </div>
    </header>

    <main id="mainContainer" class="p-4 md:p-6 pt-36 md:pt-28 relative mx-auto min-h-screen transition-[max-width] duration-200 ease-out" style="max-width: 1390px;">
        
        <div id="emptyState" class="hidden min-h-[70vh] flex flex-col items-center justify-center text-neutral-400">
            <div class="w-20 h-20 bg-neutral-100 rounded-2xl flex items-center justify-center mb-5 text-neutral-300"><i class="ph-fill ph-images text-4xl"></i></div>
            <p class="text-base font-medium text-neutral-500">No screenshots yet</p>
            <p class="text-sm text-neutral-400 mt-1">Tap "Add New" to start</p>
        </div>

        <div id="folderWrapper" class="flex flex-col gap-12 pb-32"></div>

    </main>

    <div id="statusBar" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-neutral-900/90 backdrop-blur-md text-white px-5 py-2.5 rounded-full shadow-2xl flex items-center gap-3 hidden transition-all z-50">
        <div class="w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"></div><span id="statusText" class="text-xs font-medium">Processing...</span>
    </div>
    
    <div id="dragOverlay" class="fixed inset-0 bg-neutral-900/5 backdrop-blur-sm z-50 pointer-events-none opacity-0 flex items-center justify-center transition-opacity duration-200">
        <div class="drop-overlay-card px-10 py-8 flex flex-col items-center gap-4">
            <div class="p-4 bg-blue-50 text-blue-500 rounded-2xl"><i class="ph-fill ph-upload-simple text-3xl"></i></div>
            <p class="text-lg font-semibold text-neutral-700">Drop images to import</p>
        </div>
    </div>

    <script>
        // --- STATE ---
        let appData = { cards: [], folders: [] };
        let deletedCardsStack = [], undoTimeout = null, dragSrcId = null, dragSrcTags = null, db;

        const DB_NAME = "SSavedDB";
        const DB_VERSION = 3; // Bump for tags migration 
        const INBOX_ID = 'inbox';

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            loadDataFromDB();
            setupGlobalDrag();
            initScrollBehavior();
            
            // Prefs
            const w = localStorage.getItem('ssaved_width');
            if (w) { document.getElementById('widthSlider').value = w; updateWidth(w); }
            setMobileCols(localStorage.getItem('ssaved_cols') || 1);
        });

        // --- SCROLL BEHAVIOR ---
        function initScrollBehavior() {
            const header = document.getElementById('mainHeader');
            let lastScrollY = window.scrollY;
            window.addEventListener('scroll', () => {
                const currentScrollY = window.scrollY;
                if (currentScrollY < 0) return;
                if (Math.abs(currentScrollY - lastScrollY) < 10) return;
                if (currentScrollY > lastScrollY && currentScrollY > 60) header.classList.add('-translate-y-full');
                else header.classList.remove('-translate-y-full');
                lastScrollY = currentScrollY;
            }, { passive: true });
        }

        // --- DATABASE ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = (e) => { 
                    const db = e.target.result; 
                    if (!db.objectStoreNames.contains("cards")) db.createObjectStore("cards", { keyPath: "id" });
                    if (!db.objectStoreNames.contains("folders")) db.createObjectStore("folders", { keyPath: "id" });
                };
                req.onsuccess = (e) => { db = e.target.result; resolve(db); };
                req.onerror = (e) => reject("DB Error");
            });
        }
        function saveCardToDB(card) { if (!db) return; const c = { ...card }; delete c.imageUrl; db.transaction("cards", "readwrite").objectStore("cards").put(c); showSaved(); }
        function saveFolderToDB(folder) { if (!db) return; db.transaction("folders", "readwrite").objectStore("folders").put(folder); }
        function loadDataFromDB() {
            if (!db) return;
            const tx = db.transaction(["cards", "folders"], "readwrite");
            
            tx.objectStore("folders").getAll().onsuccess = (e) => {
                let folders = e.target.result;
                if (!folders.length) { folders = [{ id: INBOX_ID, name: 'Inbox', order: 0, isCollapsed: false }]; saveFolderToDB(folders[0]); }
                appData.folders = folders.map(f => ({...f, isCollapsed: !!f.isCollapsed})).sort((a,b) => a.order - b.order);
            };

            tx.objectStore("cards").getAll().onsuccess = (e) => {
                const raw = e.target.result.map(c => ({...c, imageUrl: URL.createObjectURL(c.file), tags: c.tags || (c.folderId ? [c.folderId] : [INBOX_ID]) }));
                let fix = false; raw.forEach((c, i) => { if(c.order === undefined) { c.order = i; fix = true; }});
                appData.cards = raw.sort((a, b) => a.order - b.order);
                if(fix) reindexCards(INBOX_ID);
                render(); 
            };
        }
        function reindexCards(folderId) {
            const subset = appData.cards.filter(c => c.tags && c.tags.includes(folderId)).sort((a,b) => a.order - b.order);
            subset.forEach((c, i) => { c.order = i; saveCardToDB(c); });
        }

        // --- RENDER ---
        function render(restoreId = null) {
            const wrapper = document.getElementById('folderWrapper');
            const empty = document.getElementById('emptyState');
            const rIds = Array.isArray(restoreId) ? restoreId : (restoreId ? [restoreId] : []);

            const hasCards = appData.cards.length > 0;
            const hasCustomFolders = appData.folders.length > 1;

            if (!hasCards && !hasCustomFolders) { 
                empty.classList.remove('hidden'); wrapper.innerHTML = ''; return; 
            }
            empty.classList.add('hidden');
            wrapper.innerHTML = '';

            const mCols = localStorage.getItem('ssaved_cols') || 1;
            const gridClass = `grid-cols-${mCols} md:grid-cols-2 lg:grid-cols-3`;

            appData.folders.forEach(folder => {
                const fCards = appData.cards.filter(c => c.tags && c.tags.includes(folder.id));
                const cardsHtml = fCards.map(c => generateCardHTML(c, rIds)).join('');
                const chevron = folder.isCollapsed ? 'ph-caret-right' : 'ph-caret-down';
                const gridState = folder.isCollapsed ? 'hidden' : '';
                const opacity = folder.isCollapsed ? 'opacity-50' : 'opacity-100';

                // Delete button for folders
                const deleteBtn = folder.id === INBOX_ID ? '' : `
                <button onclick="event.stopPropagation(); deleteFolder('${folder.id}')" 
                        class="ml-auto mr-4 p-1.5 text-neutral-300 hover:text-red-500 transition-colors rounded-md opacity-0 group-hover/folder:opacity-100"
                        title="Delete Folder">
                    <i class="ph-bold ph-x text-sm"></i>
                </button>`;

                const section = `
                <section id="folder-${folder.id}" class="folder-enter group/folder">
                    <div class="mb-5 flex items-end relative pl-1 cursor-pointer"
                         onclick="toggleFolder('${folder.id}')"
                         ondragover="handleFolderDragOver(event, '${folder.id}')"
                         ondragleave="handleFolderDragLeave(event, '${folder.id}')"
                         ondrop="handleFolderDrop(event, '${folder.id}')">
                         
                        <div class="folder-tab bg-neutral-200/80 text-neutral-500 py-1.5 text-xs font-semibold uppercase tracking-wider rounded-t-lg transition-all duration-200 select-none group-hover/folder:bg-neutral-300/80 group-hover/folder:text-neutral-600 flex items-center gap-2 ${opacity}">
                            <i class="ph-bold ${chevron} text-xs"></i>
                            ${folder.name} 
                            <span class="opacity-50 font-normal">${fCards.length}</span>
                        </div>
                        
                        ${deleteBtn}
                        <div class="h-px bg-neutral-200/60 w-full mb-px absolute bottom-0 left-0 right-0 -z-10"></div>
                    </div>

                    <div class="folder-grid-area grid ${gridClass} gap-5 md:gap-6 min-h-[50px] transition-all duration-300 ${gridState}"
                         ondragover="handleFolderDragOver(event, '${folder.id}')"
                         ondragleave="handleFolderDragLeave(event, '${folder.id}')"
                         ondrop="handleFolderDrop(event, '${folder.id}')">
                        ${cardsHtml}
                    </div>
                </section>`;
                wrapper.insertAdjacentHTML('beforeend', section);
            });
        }

        function generateCardHTML(c, rIds) {
            const isRestored = c.isRestored ? "is-restored" : "";
            const restoreAttr = c.isRestored ? `onmouseenter="clearRestoreStatus(${c.id})"` : "";
            const pulse = c.isScanning ? "animate-pulse-subtle" : "";
            const enter = rIds.includes(c.id) ? 'animate-restore' : '';
            
            const hasSuggestions = !c.isScanning && c.suggestions.length !== 1;
            let tooltip = "";
            if (hasSuggestions) {
                const content = c.suggestions.length === 0 
                    ? `<div class="bg-white/95 backdrop-blur-md rounded-xl p-3 shadow-xl border border-neutral-100 text-xs text-neutral-500 text-center">No valid text found.</div>`
                    : `<div class="bg-white/95 backdrop-blur-md rounded-xl p-3 shadow-xl border border-neutral-100"><div class="flex flex-wrap gap-2">${c.suggestions.map(w => `<button onmousedown="event.preventDefault(); applySuggestion(${c.id}, '${cleanString(w)}')" class="px-2.5 py-1.5 bg-neutral-50 hover:bg-neutral-100 border border-neutral-200 text-neutral-600 text-xs font-medium rounded-lg transition-all">${w}</button>`).join('')}</div></div>`;
                tooltip = `<div id="tooltip-${c.id}" class="tooltip-container absolute bottom-full left-0 w-full mb-3 z-50"><div class="tooltip-arrow relative">${content}</div></div>`;
            }

            return `
            <div id="card-${c.id}" draggable="true" 
                 ondragstart="handleDragStart(event, ${c.id})" 
                 ondragover="handleCardDragOver(event, ${c.id})" 
                 ondrop="handleCardDrop(event, ${c.id})" 
                 ondragend="handleDragEnd(event)" 
                 ${restoreAttr} 
                 style="view-transition-name: card-${c.id}" 
                 class="card group flex flex-col ${isRestored} ${pulse} ${enter}">
                
                <div class="aspect-[9/16] bg-neutral-100 relative overflow-hidden group/image shrink-0 cursor-pointer" onclick="handleImageClick(event, ${c.id})">
                    <img src="${c.imageUrl}" class="w-full h-full object-cover object-top pointer-events-none transition-transform duration-500 img-hover-scale" loading="lazy">
                    
                    <!-- External Link Button -->
                    <button onclick="event.stopPropagation(); openProfile(${c.id})" class="external-link-btn p-2 bg-white/80 hover:bg-white backdrop-blur-md border border-white/50 text-neutral-600 hover:text-neutral-900 rounded-lg shadow-lg transition-all">
                        <i class="ph-bold ph-arrow-up-right text-base"></i>
                    </button>
                    
                    <!-- Delete Button -->
                    <button onclick="event.stopPropagation(); deleteCard(${c.id})" class="delete-btn p-2 bg-white/80 hover:bg-red-50 backdrop-blur-md border border-white/50 text-neutral-600 hover:text-red-500 rounded-lg shadow-lg transition-all">
                        <i class="ph-bold ph-x text-base"></i>
                    </button>
                </div>

                <div class="p-4 flex flex-col gap-3 flex-1">
                    <div class="relative username-wrapper z-10">
                        ${tooltip}
                        <div class="relative group/input">
                            <div class="absolute inset-y-0 left-0 pl-1 flex items-center pointer-events-none"><span class="text-neutral-300 font-medium">@</span></div>
                            <textarea 
                                oninput="autoResize(this); updateCard(${c.id}, 'username', this.value)" 
                                onfocus="autoResize(this); ${hasSuggestions ? `triggerTooltip(${c.id})` : ''}"
                                class="auto-grow w-full pl-6 pr-8 py-1 bg-transparent border-0 border-b border-neutral-100 focus:border-neutral-300 outline-none text-sm font-semibold text-neutral-400 group-hover/input:text-neutral-700 focus:text-neutral-900 transition-colors placeholder:text-neutral-300" 
                                placeholder="Username" rows="1">${c.username}</textarea>
                            ${hasSuggestions ? `<div class="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none"><i class="ph-fill ph-magic-wand text-neutral-300 text-sm"></i></div>` : ''}
                        </div>
                    </div>
                    <textarea 
                        oninput="autoResize(this); updateCard(${c.id}, 'notes', this.value)" 
                        onfocus="autoResize(this)"
                        class="auto-grow w-full text-xs text-neutral-500 bg-transparent border-0 border-b border-neutral-50 focus:border-neutral-200 outline-none resize-none p-1 placeholder:text-neutral-300" 
                        rows="1" placeholder="Add notes...">${c.notes}</textarea>
                </div>
            </div>`;
        }

        // --- JS UTILS FOR AUTO-GROW ---
        function autoResize(el) {
            el.style.height = 'auto'; 
            el.style.height = el.scrollHeight + 'px';
        }

        // --- DRAG & DROP V2 ---
        function handleDragStart(e, id) {
            dragSrcId = id;
            const c = appData.cards.find(x => x.id === id);
            dragSrcTags = c ? [...(c.tags || [INBOX_ID])] : null;

            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', id);

            // Mobile drag fix
            const card = document.getElementById(`card-${id}`);
            if (card) {
                const buttons = card.querySelectorAll('button, .external-link-btn, .delete-btn');
                buttons.forEach(btn => btn.style.opacity = '0');
                try {
                    e.dataTransfer.setDragImage(card, card.offsetWidth / 2, 50);
                } catch(err) {}
                setTimeout(() => buttons.forEach(btn => btn.style.opacity = ''), 50);
            }

            document.body.classList.add('global-dragging');
            setTimeout(() => document.getElementById(`card-${id}`)?.classList.add('is-dragging'), 0);
        }

        function handleFolderDragOver(e, folderId) {
            if (!dragSrcId || (dragSrcTags && dragSrcTags.includes(folderId))) return;
            e.preventDefault(); e.dataTransfer.dropEffect = 'move';
            document.getElementById(`folder-${folderId}`).classList.add('folder-drop-active');
            
            const f = appData.folders.find(x => x.id === folderId);
            if(f && f.isCollapsed) { f.isCollapsed = false; saveFolderToDB(f); render(); }
        }
        function handleFolderDragLeave(e, folderId) {
            if (e.relatedTarget && document.getElementById(`folder-${folderId}`).contains(e.relatedTarget)) return;
            document.getElementById(`folder-${folderId}`).classList.remove('folder-drop-active');
        }
        function handleFolderDrop(e, folderId) {
            e.preventDefault();
            document.getElementById(`folder-${folderId}`).classList.remove('folder-drop-active');
            if (dragSrcId && dragSrcTags && !dragSrcTags.includes(folderId)) {
                const c = appData.cards.find(x => x.id === dragSrcId);
                if (c) {
                    // Add new folder tag
                    if (!c.tags.includes(folderId)) c.tags.push(folderId);

                    // Remove inbox tag when moving to a specific folder (not inbox itself)
                    if (folderId !== INBOX_ID && c.tags.includes(INBOX_ID)) {
                        c.tags = c.tags.filter(t => t !== INBOX_ID);
                    }

                    // Let reindexCards handle order assignment (removed c.order = 0)
                    saveCardToDB(c);
                    reindexCards(folderId);
                    dragSrcTags.forEach(oldTag => reindexCards(oldTag));
                    transitionRender();
                }
            }
        }

        function handleCardDragOver(e, targetId) {
            e.preventDefault(); e.dataTransfer.dropEffect = 'move';
            if (!dragSrcId || dragSrcId === targetId) return;

            const targetCard = appData.cards.find(c => c.id === targetId);
            const commonFolder = dragSrcTags?.find(tag => targetCard.tags && targetCard.tags.includes(tag));
            if (!commonFolder) return;

            const folderCards = appData.cards.filter(c => c.tags && c.tags.includes(commonFolder)).sort((a,b) => a.order - b.order);
            const from = folderCards.findIndex(c => c.id === dragSrcId);
            const to = folderCards.findIndex(c => c.id === targetId);

            if (from === -1 || to === -1) return;

            document.querySelectorAll('.card-shift-forward, .card-shift-backward').forEach(el => { el.classList.remove('card-shift-forward', 'card-shift-backward'); el.style.transform = ''; });
            
            const start = Math.min(from, to), end = Math.max(from, to);
            for (let i = start; i <= end; i++) {
                if (i === from) continue;
                const el = document.getElementById(`card-${folderCards[i].id}`);
                if (el) el.classList.add(from < to ? 'card-shift-forward' : 'card-shift-backward');
            }
        }

        function handleCardDrop(e, targetId) {
            e.stopPropagation(); e.preventDefault();
            if (!dragSrcId || dragSrcId === targetId) return;

            const targetCard = appData.cards.find(c => c.id === targetId);
            const commonFolder = dragSrcTags?.find(tag => targetCard.tags && targetCard.tags.includes(tag));

            if (commonFolder) {
                const folderCards = appData.cards.filter(c => c.tags && c.tags.includes(commonFolder)).sort((a,b) => a.order - b.order);
                const from = folderCards.findIndex(c => c.id === dragSrcId);
                const to = folderCards.findIndex(c => c.id === targetId);

                if (from > -1 && to > -1) {
                    const [moved] = folderCards.splice(from, 1);
                    folderCards.splice(to, 0, moved);
                    folderCards.forEach((c, i) => { c.order = i; saveCardToDB(c); });
                    appData.cards.sort((a,b) => a.order - b.order);
                    transitionRender();
                }
            } else {
                handleFolderDrop(e, targetCard.folderId);
            }
        }

        function handleDragEnd() {
            document.body.classList.remove('global-dragging');
            document.querySelectorAll('.is-dragging, .card-shift-forward, .card-shift-backward, .folder-drop-active').forEach(el => {
                el.classList.remove('is-dragging', 'card-shift-forward', 'card-shift-backward', 'folder-drop-active'); el.style.transform = '';
            });
            dragSrcId = null; dragSrcFolderId = null;
        }

        // --- ACTIONS ---
        function createNewFolder() {
            const name = prompt("Folder Name:");
            if (name) {
                const id = 'folder-' + Date.now();
                const newFolder = { id, name, order: appData.folders.length, isCollapsed: false };
                appData.folders.push(newFolder);
                saveFolderToDB(newFolder);
                render();
            }
        }
        
        function toggleFolder(id) {
            const f = appData.folders.find(x => x.id === id);
            if (f) {
                f.isCollapsed = !f.isCollapsed;
                saveFolderToDB(f);
                render();
            }
        }

        function deleteFolder(id) {
            if(id === INBOX_ID) return;
            if(!confirm("Delete this folder? Cards will keep other folder tags.")) return;

            const cardsWithTag = appData.cards.filter(c => c.tags && c.tags.includes(id));
            cardsWithTag.forEach(c => {
                c.tags = c.tags.filter(t => t !== id);
                if (c.tags.length === 0) c.tags = [INBOX_ID];
                saveCardToDB(c);
            });

            const idx = appData.folders.findIndex(f => f.id === id);
            if(idx > -1) {
                appData.folders.splice(idx, 1);
                const tx = db.transaction("folders", "readwrite");
                tx.objectStore("folders").delete(id);
            }
            reindexCards(INBOX_ID);
            render();
        }

        // --- FILE & OCR ---
        function simpleCrop(url) {
            return new Promise((resolve) => {
                const img = new Image(); img.onload = () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                    const h = img.height * 0.2; c.width = img.width; c.height = h;
                    ctx.drawImage(img, 0, 0, img.width, h, 0, 0, img.width, h);
                    c.toBlob(resolve);
                }; img.src = url;
            });
        }
        async function handleFiles(files) {
            if (!files.length) return;
            showStatus(true, `Processing ${files.length}...`);
            const newCards = Array.from(files).map((f, i) => ({ 
                id: Date.now() + i, file: f, imageUrl: URL.createObjectURL(f), 
                username: "", notes: "", link: "#", isScanning: true, suggestions: [], tags: [INBOX_ID] 
            }));
            
            newCards.forEach(c => saveCardToDB(c));
            appData.cards.unshift(...newCards);
            reindexCards(INBOX_ID);
            
            transitionRender(newCards.map(c => c.id));
            await new Promise(r => setTimeout(r, 100)); // Pause for UI

            for (const c of newCards) {
                try {
                    const blob = await simpleCrop(c.imageUrl);
                    const { data: { words } } = await Tesseract.recognize(blob, 'eng');
                    const banned = ['follow', 'followers', 'following', 'posts'];
                    const valid = words.map(w => w.text.trim()).filter(w => w.length > 4 && !/[:;,]/.test(w) && !banned.includes(w.toLowerCase())).sort((a,b) => b.length - a.length);
                    const best = valid[0] ? cleanString(valid[0]) : "";
                    
                    const actual = appData.cards.find(x => x.id === c.id);
                    if (actual) {
                        Object.assign(actual, { username: best, link: `https://instagram.com/${best}`, suggestions: valid, isScanning: false });
                        saveCardToDB(actual);
                        const el = document.getElementById(`card-${actual.id}`);
                        if(el) {
                           const txt = el.querySelector('textarea[placeholder="Username"]');
                           if(txt && document.activeElement!==txt) { txt.value = best; autoResize(txt); }
                           el.querySelector('.external-link-btn')?.setAttribute('onclick', `event.stopPropagation(); openProfile(${actual.id})`);
                           el.classList.remove('animate-pulse-subtle');
                        }
                    }
                } catch (e) { console.error(e); }
            }
            showStatus(false);
        }

        // --- UTILS ---
        function transitionRender(ids) { document.startViewTransition ? document.startViewTransition(() => render(ids)) : render(ids); }
        function showSaved() { const el=document.getElementById('saveIndicator'); el.classList.remove('opacity-0'); setTimeout(()=>el.classList.add('opacity-0'),2000); }
        function showStatus(show, txt) { const el=document.getElementById('statusBar'); el.classList.toggle('hidden',!show); el.classList.toggle('flex',show); document.getElementById('statusText').innerText=txt; }
        function cleanString(s) { return s.replace(/[^a-zA-Z0-9_.]/g, '').toLowerCase(); }
        function triggerUpload() { document.getElementById('fileInput').click(); }
        function triggerImport() { document.getElementById('importInput').click(); }
        
        function handleImageClick(e, id) { 
            if(!e.target.closest('button')) { 
                // Image click no longer opens link - use the explicit button instead
            }
        }
        
        function openProfile(id) {
            const c = appData.cards.find(x => x.id === id);
            if(c && c.link !== '#') window.open(c.link, '_blank');
        }

        window.addEventListener('click', (e) => { 
            if (!e.target.closest('.username-wrapper')) closeAllTooltips(); 
        });
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAllTooltips(); });
        function triggerTooltip(id) { closeAllTooltips(); document.getElementById(`tooltip-${id}`)?.classList.add('active'); }
        function closeAllTooltips() { document.querySelectorAll('.tooltip-container').forEach(e => e.classList.remove('active')); }
        function applySuggestion(id, w) { 
            const c = appData.cards.find(x => x.id === id); 
            if(c) { c.username = w; c.link = `https://instagram.com/${w}`; saveCardToDB(c); 
            const el = document.getElementById(`card-${id}`).querySelector('textarea[placeholder="Username"]');
            if(el) { el.value=w; autoResize(el); }
            closeAllTooltips(); } 
        }
        function updateCard(id, f, v) { const c = appData.cards.find(x => x.id === id); if(c) { c[f] = v; if(f==='username') c.link = `https://instagram.com/${v}`; saveCardToDB(c); } }

        function deleteCard(id) {
            const idx = appData.cards.findIndex(c => c.id === id);
            if(idx > -1) {
                deletedCardsStack.push(appData.cards.splice(idx, 1)[0]);
                const tx = db.transaction("cards", "readwrite"); tx.objectStore("cards").delete(id);
                transitionRender(); updateUndoUI();
            }
        }
        
        // --- RESTORE FIX (INSERT INSTEAD OF APPEND) ---
        function triggerUndo() {
            if (!deletedCardsStack.length) return;
            const c = deletedCardsStack.pop(); 
            c.isRestored = true;
            
            // 1. Get current list of cards in that folder
            const firstTag = c.tags && c.tags.length > 0 ? c.tags[0] : INBOX_ID;
            const folderCards = appData.cards.filter(x => x.tags && x.tags.includes(firstTag)).sort((a,b) => a.order - b.order);
            
            // 2. Insert restored card into correct position
            const insertIdx = Math.min(c.order, folderCards.length);
            folderCards.splice(insertIdx, 0, c);
            
            // 3. Re-assign order for everyone in that folder
            folderCards.forEach((card, i) => { card.order = i; saveCardToDB(card); });
            
            // 4. Update Main AppData
            appData.cards = appData.cards.filter(x => x.folderId !== c.folderId).concat(folderCards);
            
            // 5. Render
            transitionRender(c.id); 
            updateUndoUI();
        }

        function clearRestoreStatus(id) {
            const c = appData.cards.find(x => x.id === id);
            if (c?.isRestored) { 
                c.isRestored = false; 
                saveCardToDB(c); 
                document.getElementById(`card-${id}`)?.classList.remove('is-restored'); 
            }
        }
        function updateUndoUI() {
            const btn=document.getElementById('undoBtn'); 
            if(undoTimeout) clearTimeout(undoTimeout);
            if(deletedCardsStack.length) { btn.classList.remove('hidden-btn'); document.getElementById('undoText').innerText=`Undo (${deletedCardsStack.length})`; undoTimeout=setTimeout(()=>btn.classList.add('hidden-btn'),5000); }
            else btn.classList.add('hidden-btn');
        }

        function setupGlobalDrag() {
            const ov = document.getElementById('dragOverlay'); let c = 0;
            ['dragenter','dragleave','dragover','drop'].forEach(evt => window.addEventListener(evt, e => {
                if (dragSrcId) return; 
                e.preventDefault();
                if (evt === 'dragenter' && e.dataTransfer.types.includes('Files')) { c++; ov.classList.remove('opacity-0'); }
                if (evt === 'dragleave') { c--; if(c === 0) ov.classList.add('opacity-0'); }
                if (evt === 'drop') { c = 0; ov.classList.add('opacity-0'); if(e.dataTransfer.files.length) handleFiles(e.dataTransfer.files); }
            }));
        }

        function updateWidth(val) { document.getElementById('mainContainer').style.maxWidth = val > 2350 ? '100%' : `${val}px`; localStorage.setItem('ssaved_width', val); }
        function setMobileCols(n) {
            localStorage.setItem('ssaved_cols', n);
            [1,2].forEach(i => {
                const btn = document.getElementById(`col-btn-${i}`);
                if(btn) btn.className = `w-8 h-8 flex items-center justify-center rounded-md transition-all ${i==n?'bg-white text-neutral-900 shadow-sm font-bold':'text-neutral-400'}`;
            });
            render();
        }

        async function handleImport(files) {
            if (!files.length) return;
            showStatus(true, "Restoring...");
            try {
                const zip = await JSZip.loadAsync(files[0]);
                const json = JSON.parse(await zip.file("data.json").async("string"));
                const newCards = await Promise.all(json.map(async d => {
                    const blob = await zip.file("images/" + d.fileName)?.async("blob");
                    if (!blob) return null;
                    return { ...d, folderId: d.folderId || INBOX_ID, file: new File([blob], d.fileName), imageUrl: URL.createObjectURL(blob), isScanning: false };
                }));
                const valid = newCards.filter(c => c && !appData.cards.find(x => x.id === c.id));
                valid.forEach(c => saveCardToDB(c));
                appData.cards.unshift(...valid); reindexCards(INBOX_ID);
                transitionRender();
            } catch(e) { console.error(e); alert("Import failed"); }
            showStatus(false);
        }
        async function exportData() {
            if (!appData.cards.length) return;
            showStatus(true, "Zipping...");
            const zip = new JSZip(), folder = zip.folder("images");
            zip.file("data.json", JSON.stringify(appData.cards.map(c => ({...c, fileName:`img_${c.id}.png`, file:undefined, imageUrl:undefined})), null, 2));
            appData.cards.forEach(c => folder.file(`img_${c.id}.png`, c.file));
            saveAs(await zip.generateAsync({type:"blob"}), "ssaved-backup.zip");
            showStatus(false);
        }
    </script>
</body>
</html>
